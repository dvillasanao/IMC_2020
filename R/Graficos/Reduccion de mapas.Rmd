---
title: "Reduccion de mapas"
subtitle: "Mapas de México"
author: "Diana Villasana Ocampo"
output:
   html_document:
      highlight: tango
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: yes
---
\usepackage{color}
<style>
body {
text-align: justify;
font-size: 12px}
</style>

<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
</style>

```{r, include=FALSE}
# automatically create a bib database for R packages
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, #cache.extra = 
                         eval = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
setwd(here::here())
options(digits = 2)
``` 


```{r, echo = FALSE}
require(showtext)
# activar showtext
showtext_auto()
font_add_google("Montserrat", "montserrat")
```

```{r, echo = FALSE, results=FALSE}
require(dplyr)          #A Grammar of Data Manipulation 
require(forcats)        #Tools for Working with Categorical Variables (Factors)
require(ggplot2)        # Generar gráficos ggplot y la geometría de un mapa
require(ggthemes)       # Extra Themes, scale and Geoms for ggplot2
require(ggrepel)        #Automatically Position Non-Overlapping Text Labels with 'ggplot2'
require(ggmap)          #Spatial Visualization with ggplot2 
require(ggpubr)         #Based Publication Ready Plots with ggplot2
require(grid)
require(gridExtra)
require(knitr)
require(kableExtra)
require(lubridate)
require(openxlsx)
require(readxl)
require(RColorBrewer)   #ColorBrewer Palettes 
require(rgdal)          #Para importar shapefiles. 
require(sp)             # Classes and Methos for Spatial Data
require(spdplyr)        #Data manipulation verbs for the sptial classes
require(tidyverse) 
require(tmap)
require(tmaptools)
require(unikn)          # Paleta de colores
require(viridisLite)    # Paleta de colores 
```


# Zonas Metropolitanas 2020

```{r}
ZM_2020 <- read.xlsx(paste0(here::here(), "/Bases/ZM_2020.xlsx"), startRow = 7) %>%
             filter(CVE_ZM == "09.01") ## Filtro de la ZMVM

# Se guardan los municipios en un vectos 
municipios <- ZM_2020 %>%
               pull(CVE_MUN)
```

### DP2 2020

```{r}
load(file = paste0(here::here(), "/Output/IMC_", 2020, ".RData"))
```


```{r,results=FALSE, class.source = "fold-show"}
require(rgdal)
##### Estados #####
shape_estados_2020 <- readOGR(dsn ="E:/MGN/MGN 2020/MGN 2020/conjunto_de_datos", 
                          layer = "00ent",
                           encoding = "UTF-8",
                            use_iconv = TRUE)

shape_estados_2020@data <- shape_estados_2020@data %>% 
                            select(CVE_ENT)

## Se filtran municipios de la ZMVM
shape_estados_2020 <- shape_estados_2020 %>%
                       filter(CVE_ENT %in% c("09", "13", "15")) 

##### Municipios #####
shape_municipios_2020 <- readOGR(dsn ="E:/MGN/MGN 2020/MGN 2020/conjunto_de_datos", 
                                  layer = "00mun",
                                   encoding = "UTF-8",
                                    use_iconv = TRUE)

## Se filtran municipios de la ZMVM
shape_municipios_2020 <- shape_municipios_2020 %>%
                          filter(CVE_ENT %in% c("09", "13", "15"))   

shape_municipios_2020@data <- shape_municipios_2020@data %>%
                               mutate(CVE_MUN = paste0(CVE_ENT, CVE_MUN)) %>%
                                select(CVE_MUN)

##### AGEB (AGEB) ######
shape_colonias_2020 <- readOGR(dsn ="E:/MGN/MGN 2020/IMC_2020_SHP", 
                                layer = "colonias_imc2020",
                                 encoding = "UTF-8",
                                  use_iconv = TRUE)

## Se filtran municipios de la ZMVM
shape_colonias_2020 <- shape_colonias_2020 %>%
                        #filter(CVE_MUN %in% municipios) %>%
                          select(CVE_COL, CVE_MUN, GM_2020)

shape_colonias_2020 <- shape_colonias_2020  %>%
                        sp::spChFIDs(., str_pad(shape_colonias_2020@data$CVE_COL, 10, "left", pad = "0")) 
```

### Se convierte en un geojson los shapefiles

**Se transforma en geofeaturecollection**
**Se guardan los archivos geojson**

```{r}
require(geojsonio)
# Se transforma en geofeaturecollection y se guarda como archivo geojason 
capa_estados_2020_json <- geojsonio::geojson_json(shape_estados_2020, geometry = "polygon")
capa_municipio_2020_json <- geojsonio::geojson_json(shape_municipios_2020, geometry = "polygon")
capa_colonias_2020_json <- geojsonio::geojson_json(shape_colonias_2020, geometry = "polygon")
```

### Reducción de los mapas 

```{r}
require(rmapshaper)
# Se reduce el tamaño y se guarda como archivo geojason 
capa_estados_mapshaper <- rmapshaper::ms_simplify(capa_estados_2020_json, weighting = 0.9)
capa_municipios_mapshaper <- rmapshaper::ms_simplify(capa_municipio_2020_json, weighting = 0.7)
capa_colonias_mapshaper <- rmapshaper::ms_simplify(capa_colonias_2020_json, weighting = 0.5)

# Se guarda en un archivo geojson 
geojsonio::geojson_write(capa_estados_mapshaper, file = paste0(here::here(), "/Output/estados_2020_json.geojson"))
geojsonio::geojson_write(capa_municipios_mapshaper, file = paste0(here::here(), "/Output/municipios_2020_json.geojson"))
geojsonio::geojson_write(capa_colonias_mapshaper, file = paste0(here::here(), "/Output/colonias_2020_json.geojson"))
```
