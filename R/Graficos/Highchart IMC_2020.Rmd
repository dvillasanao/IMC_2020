---
title: "Indice de marginación utilizando hihgchart"
author: "Diana Villasana Ocampo"
output:
   html_document:
      highlight: tango
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: yes
---
\usepackage{color}
<style>
body {
text-align: justify;
font-size: 12px}
</style>

<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
</style>

```{r, include=FALSE}
# automatically create a bib database for R packages
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE, #cache.extra = 
                         eval = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
setwd(here::here())
```  

```{r, echo = FALSE}
# Librerías que se usaron en el documento
require(dplyr)
require(forcats)
require(sf)
require(sp)
require(spdplyr)
require(stringr)
require(rgdal)          #Para importar shapefiles.
require(geojsonio)
require(jsonlite)
require(openxlsx)
require(readxl)
require(highcharter)
require(htmlwidgets)
```



# Zonas Metropolitanas 2020

```{r}
ZM_2020 <- read.xlsx(paste0(here::here(), "/Bases/ZM_2020.xlsx"), startRow = 7) %>%
             filter(CVE_ZM == "09.01") ## Filtro de la ZMVM

# Se guardan los municipios en un vectos 
municipios <- ZM_2020 %>%
               pull(CVE_MUN)
```

### DP2 2010

```{r}
load(file = paste0(here::here(), "/Output/IMC_", 2020, ".RData"))
```

**Se filtran los datos del índice de marginación a las ZMVM (Municipios)**

```{r}
DP2_2020 <- DP2_2020 %>%
             right_join(., ZM_2020 %>% select(CVE_MUN), by = c("CVE_MUN"))
```


```{r,results=FALSE, class.source = "fold-show"}
require(rgdal)
##### Estados #####
shape_estados_2020 <- readOGR(dsn ="E:/MGN/MGN 2020/MGN 2020/conjunto_de_datos", 
                          layer = "00ent",
                           encoding = "UTF-8",
                            use_iconv = TRUE)

shape_estados_2020@data <- shape_estados_2020@data %>% 
                            select(CVE_ENT)

## Se filtran municipios de la ZMVM
shape_estados_2020 <- shape_estados_2020 %>%
                       filter(CVE_ENT %in% c("09", "13", "15")) 

##### Municipios #####
shape_municipios_2020 <- readOGR(dsn ="E:/MGN/MGN 2020/MGN 2020/conjunto_de_datos", 
                                  layer = "00mun",
                                   encoding = "UTF-8",
                                    use_iconv = TRUE)

## Se filtran municipios de la ZMVM
shape_municipios_2020 <- shape_municipios_2020 %>%
                          filter(CVE_ENT %in% c("09", "13", "15"))   

shape_municipios_2020@data <- shape_municipios_2020@data %>%
                               mutate(CVE_MUN = paste0(CVE_ENT, CVE_MUN)) %>%
                                select(CVE_MUN)

## Se filtran los municipios de la ZMVM 
shape_municipios_2020 <- shape_municipios_2020 %>%
                          filter(CVE_MUN %in% municipios)


##### Colonias ######
shape_colonias_2020 <- readOGR(dsn ="E:/MGN/MGN 2020/IMC_2020_SHP", 
                                layer = "colonias_imc2020",
                                 encoding = "UTF-8",
                                  use_iconv = TRUE)

## Se filtran municipios de la ZMVM
shape_colonias_2020 <- shape_colonias_2020 %>%
                        filter(CVE_MUN %in% municipios) %>%
                          select(CVE_COL, GM_2020)

shape_colonias_2020 <- shape_colonias_2020  %>%
                        sp::spChFIDs(., str_pad(shape_colonias_2020@data$CVE_COL, 10, "left", pad = "0")) 
```


Haciendo uso de la función `spTransform()` del paquete `sp`, proporcionan la transformación entre datum(s) y conversión entre proyecciones (también conocidas como *proyección y/o reproyección*), de un sistema de referencia de coordenadas (`CRS`). 

```{r}
#Paquetes
require(sp)
shape_estados <- spTransform(shape_estados_2020, CRSobj = CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')) 
shape_municipios <- spTransform(shape_municipios_2020, CRSobj = CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs'))
shape_colonias <- spTransform(shape_colonias_2020, CRSobj = CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs'))
```


## Geojson 

```{r}
capa_estados <- geojsonio::geojson_json(shape_estados, geometry = "polygon")
capa_municipios <- geojsonio::geojson_json(shape_municipios, geometry = "polygon")
capa_colonias <- geojsonio::geojson_json(shape_colonias, geometry = "polygon")
```


# RMapshaper

```{r}
capa_estados_rmapshaper <- rmapshaper::ms_simplify(capa_estados, keep = 0.07)
capa_municipios_rmapshaper <- rmapshaper::ms_simplify(capa_municipios, keep = 0.05)
capa_colonias_rmapshaper <- rmapshaper::ms_simplify(capa_colonias, keep = 0.05)
```


# Hihgchart

```{r}
require(unikn)
require(RColorBrewer)
paleta <- rev(RColorBrewer::brewer.pal(5, 'YlGnBu'))

## DataClasses
color_clss <- DP2_2020 %>% 
               mutate(GM_2020 = fct_relevel(.$GM_2020, c("Muy alto", "Alto", "Medio", "Bajo", "Muy bajo"))) %>%
                 arrange(GM_2020) %>%
                   mutate(value = cumsum(!duplicated(GM_2020))) %>% 
                    group_by(GM_2020) %>%
                    summarise(value = unique(value)) %>% 
                     arrange(value) %>% 
                       rename(name = GM_2020, from = value) %>% 
                         mutate(to = from + 1, 
                                color = paleta) %>% 
                          list_parse()

## Datos 
tabla <- data.frame(CVE_COL = shape_colonias_2020@data$CVE_COL) %>% 
                     inner_join(., DP2_2020, by = c("CVE_COL")) %>%
          mutate(GM_2020 = fct_relevel(.$GM_2020, c("Muy alto", "Alto", "Medio", "Bajo", "Muy bajo"))) %>%
           mutate(value = case_when(.$GM_2020 == "Muy alto" ~ 1, 
                                    .$GM_2020 == "Alto" ~ 2, 
                                    .$GM_2020 == "Medio" ~ 3, 
                                    .$GM_2020 == "Bajo" ~ 4, 
                                    .$GM_2020 == "Muy bajo" ~ 5)) 

### Se transforma el mapa de estados en formtato json
capa_estados_json <- capa_estados_rmapshaper %>% 
                      fromJSON(simplifyVector = FALSE) |>
                       as.json()

capa_municipios_json <- capa_municipios_rmapshaper %>% 
                         fromJSON(simplifyVector = FALSE) |>
                          as.json()
```

```{r}
p <- highchart(type = "map")  %>%
       #hc_add_series(mapData = capa_estados_json, showInLegend = FALSE, borderColor = "#000000", borderWidth = 2, 
        #nullColor = "rgba(200, 200, 200, 0.2)", opacity = 1) %>%
       hc_add_series(mapData = capa_municipios_json, showInLegend = FALSE, borderColor = "#464646", borderWidth = 1, backgroundColor = 'transparent', opacity = 1) %>%
        hc_add_series(mapData = capa_colonias_rmapshaper,
                       tabla, 
                        joinBy = c("CVE_COL", "CVE_COL"), 
                         name = "IMC 2020",
                          value = "value", 
                           opacity = 1,
                            borderWidth = 0.01,
                            tooltip = list(pointFormat = "Clave: <b>{point.CVE_COL} <br> </b> 
                                                          Colonia: <b>{point.NOM_COLONIA} <br> </b> 
                                                          Municipio: <b>{point.NOM_MUN} <br> </b> 
                                                          Entidad: <b>{point.NOM_ENT} <br> </b> 
                                                          Grado: <b>{point.GM_2020} <br> </b> 
                                                          IM: <b>{point.IM_2020:.2f} <br> </b>
                                                          IMN: <b>{point.IMN_2020:.2f}<br> </b>"),
                        dataLabels = list(enabled = FALSE, pointformat = "{point.CVE_COL:}")) %>% 
         hc_colorAxis(dataClasses = color_clss) %>%
          hc_mapNavigation(enabled = TRUE, enableDoubleClickZoomTo = TRUE) %>% 
           hc_chart(zoomType = "xy"
                    )
p

saveRDS(p, file = paste0(here::here(),"/Output/Mapa.rds"))
htmlwidgets::saveWidget(p, file = paste0(here::here(),"/Output/Mapa.html"))
```






